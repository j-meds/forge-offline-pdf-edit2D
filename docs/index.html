<head>
  <meta charset="utf-8" />
  <title>fast PDF viewer with markup and offline support</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="./skeleton.min.css" />
  <style>
    .lmv-markup-gui-toolbar {
      background-color: rgba(200, 230, 255, 0.85);
    }
  </style>
</head>

<body style="margin: 0; overflow-y: hidden">
  <div class="container">
    <nav class="navbar">
      <div class="container">
        <ul class="navbar-list">
          <li class="navbar-item">
            <img class="navbar-img" width="140" src="logo.png" />
          </li>
          <li class="navbar-item">
            <button
              onClick="initializeViewer('pdfs/qcad1.pdf')"
              class="navbar-button button-primary"
            >
              floor1.pdf
            </button>

            <button
              onClick="startTool(window.tools.polygonTool)"
              class="navbar-button button-primary"
            >
              Draw polygon
            </button>
            <button
              onClick="startTool(window.tools.polylineTool)"
              class="navbar-button button-primary"
            >
              Draw lines
            </button>
            <button
              onClick="startTool(window.tools.polygonEditTool)"
              class="navbar-button button-primary"
            >
              Edit polygon or lines
            </button>
            <button
              onClick="startTool()"
              class="navbar-button button-primary"
            >
              Stop Polygon tool
            </button>
          </li>
          </li>
          <!-- Uncomment to switch pdf views -->
          <!-- <li class="navbar-item">
            <button
              onClick="initializeViewer('pdfs/wood.pdf')"
              class="navbar-button button-primary"
            >
              Wood.pdf
            </button>
          </li>
          <li class="navbar-item">
            <button
              onClick="initializeViewer('pdfs/qcad3.pdf')"
              class="navbar-button button-primary"
            >
              section.pdf
            </button>
          </li>
          <li class="navbar-item">
            <button
              onClick="initializeViewer('pdfs/2018035DCD1008A0.pdf')"
              class="navbar-button button-primary"
            >
              bug1.pdf
            </button>
          </li>
          <li class="navbar-item">
            <button
              onClick="initializeViewer('pdfs/2018035DCD03003A4.pdf')"
              class="navbar-button button-primary"
            >
              bug2.pdf
            </button>
          </li> -->
          <li class="navbar-itemr mobile">
            <a class="navbar-link" href="https://kelarpacific.com"
              >Fencing Project</a
            >
          </li>
        </ul>
      </div>
    </nav>
  </div>
  <div id="forgeViewer"></div>
</body>

<link
  rel="stylesheet"
  href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css"
  type="text/css"
/>
<script
  language="JavaScript"
  src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.js"
></script>

<script
  language="JavaScript"
  src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/extensions/Edit2D/Edit2D.min.js"
></script>

<script>
  let viewer, markup;

  const unitHandler = new Autodesk.Edit2D.SimpleUnitHandler(viewer);
  unitHandler.layerUnit    = 'in';
  unitHandler.displayUnits = 'cm';
  unitHandler.digits       = 4;

  function initializeViewer(pdf) {
    if (viewer) {
      console.log("loading");
      viewer.impl.unloadCurrentModel();
      if (markup) markup.hide();
      viewer.loadModel(pdf, viewer);                   
      return;
    }

    var options = {
      env: "Local",
      useADP: false,
      // arc: false
    };

    Autodesk.Viewing.Initializer(options, () => {
      viewer = new Autodesk.Viewing.GuiViewer3D(
        document.getElementById("forgeViewer")
      );
      viewer.setTheme("light-theme");
      viewer.start();
      if (!pdf) return;

      viewer.loadExtension("Autodesk.PDF").then(() => {
        viewer.loadModel(pdf, viewer, () => {
          
          viewer.loadExtension("Autodesk.Edit2D").then((edit2d) => {
            // Register all standard tools in default configuration
            edit2d.registerDefaultTools();
           
          }); 
          // Disable markup and only use Edit2D
          // viewer.loadExtension("Autodesk.Viewing.MarkupsCore");
          // viewer.loadExtension("Autodesk.Viewing.MarkupsGui");    
        });
           
      });      
    }); 
  }

  if ("xserviceWorker" in navigator)
    navigator.serviceWorker.register("offline-worker.js");


  initializeViewer("pdfs/3bed.pdf");


  setTimeout(() => {
     // Facilitate access to extension and layer
    window.edit2d = NOP_VIEWER.getExtension('Autodesk.Edit2D');
    window.layer  = window.edit2d.defaultContext.layer;
    window.tools  = window.edit2d.defaultTools;    

    console.log(window.tools);
  }, 2500);

// Convenience function for tool switching per console. E.g. startTool(tools.polygonTool)
function startTool (tool) {
    var controller = NOP_VIEWER.toolController;    

    // Check if currently active tool is from Edit2D
    var activeTool = controller.getActiveTool();
    var isEdit2D = activeTool && activeTool.getName().startsWith("Edit2");

    console.log(activeTool.getName());

    // deactivate any previous edit2d tool
    if (isEdit2D) {
      controller.deactivateTool(activeTool.getName());
      activeTool = null;
    }

    // stop editing tools
    if (!tool) {
      return;
    }

    tool.setLengthLabelVisible(true);
    controller.activateTool(tool.getName());
  }

</script>
